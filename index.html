<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>GrowGreen App</title>

  <!-- Load QR Scanner library -->
  <script src="https://unpkg.com/html5-qrcode@2.0.9/dist/html5-qrcode.min.js"></script>

  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      background: #f9f9f9;
    }

    header img {
      width: 100%;
      max-height: 100%;
      object-fit: cover;
      display: block;
    }

    main {
      flex: 1;
      padding: 15px;
      text-align: center;
    }

    .search-box {
      margin: 15px 0;
    }

    input[type="text"] {
      padding: 10px;
      width: 65%;
      max-width: 300px;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-bottom: 12px;
    }

    button {
      padding: 10px 20px;
      margin: 5px;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      background: #4caf50;
      color: white;
      font-weight: bold;
    }

    button:hover {
      background: #43a047;
    }

    #result {
      margin-top: 20px;
      background: #ffffff;
      padding: 15px;
      border-radius: 12px;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      display: none;
      text-align: left;
    }

    #result h3 {
      margin-top: 0;
      border-bottom: 2px solid #e0e0e0;
      padding-bottom: 5px;
    }

    /* Layout: details left, image + price right */
    .cardContent {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
    }

    .details-left {
      flex: 2;
    }

    .image-right {
      flex: 1;
      text-align: center;
    }

    #productImage {
      width: 100px;
      height: auto;
      margin-bottom: 8px;
      border-radius: 8px;
    }

    .priceHighlight {
      font-size: 20px;
      font-weight: bold;
      color: #1a8917;
    }

    #result .row {
      display: flex;
      padding: 4px 0;
    }

    #result .row span.label {
      width: 120px;
      font-weight: bold;
    }

    /* Scanner portion – adjustable size and border */
    #qr-reader {
      width: 100%;
      max-width: 350px;
      height: 260px;
      margin: 20px auto;
      border: 4px solid #1a8917; /* change thickness + color */
      border-radius: 18px;        /* rounded corners */
      overflow: hidden;
      display: none;
    }

    footer {
      background: #333;
      color: white;
      text-align: center;
      padding: 10px;
      margin-top: auto;
    }
  </style>
</head>
<body>
  <!-- Banner -->
  <header>
    <img src="Banner.png" alt="GrowGreen Banner" />
  </header>

  <main>
    <!-- Search box -->
    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Enter Barcode or Product Name" />
      <br />
      <button onclick="searchProduct()">Search</button>
      <button onclick="toggleScan()">Scan</button>
    </div>

    <!-- QR Scanner -->
    <div id="qr-reader"></div>

    <!-- Product result -->
    <div id="result">
      <h3 id="cardHeading">Product Details</h3>
      <div class="cardContent">
        <div class="details-left" id="details"></div>
        <div class="image-right">
          <img id="productImage" src="" alt="Product Image" style="display:none;" />
          <div class="priceHighlight" id="productPrice"></div>
        </div>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <footer>
    © GrowGreen Sabya Jazan Kingdom of Saudi Arabia. All Rights Reserved.
  </footer>

  <script>
    const inventory = {};
    let html5QrCode;
    let scanning = false;

    // Load data from Google Sheets (OpenSheet API)
    async function loadInventory() {
      const sheetUrl = "https://opensheet.elk.sh/1O0vlldmzxvOqJQ5Ko9OqmVLrk-RjGUilxVSnwKmuvXc/Inventory";
      try {
        const res = await fetch(sheetUrl);
        const data = await res.json();

        data.forEach(row => {
          const cleanedRow = {};
          Object.keys(row).forEach(k => {
            cleanedRow[k.trim()] = row[k] ? row[k].trim() : "";
          });

          if (cleanedRow.Barcode) {
            inventory[cleanedRow.Barcode] = {
              code: cleanedRow["Product Code"] || "",
              name: cleanedRow["Product Name"] || "",
              qty: cleanedRow["Qty"] || "",
              unit: cleanedRow["Unit"] || "",
              magas: cleanedRow["Magas"] || "",
              mrp: cleanedRow["MRP"] || "",
              brand: cleanedRow["Brand"] || "",
              usage: cleanedRow["Usage"] || "",
              image: cleanedRow["Image"] || ""
            };
          }
        });

        console.log("✅ Inventory loaded:", inventory);
      } catch (err) {
        console.error("❌ Error loading inventory:", err);
      }
    }

    loadInventory();

    function formatText(text) {
      return text ? text.replace(/\b\w/g, (c) => c.toUpperCase()) : "";
    }

    function showProduct(code) {
      const product = inventory[code];
      const resultBox = document.getElementById("result");
      const details = document.getElementById("details");
      const productImage = document.getElementById("productImage");
      const productPrice = document.getElementById("productPrice");
      const heading = document.getElementById("cardHeading");

      if (product) {
        // Heading with product code
        heading.innerHTML = `Product Details <span style="color:#1a8917; font-size:14px;">Code: ${product.code}</span>`;

        // Image
        if (product.image) {
          productImage.src = product.image;
          productImage.style.display = "block";
        } else {
          productImage.style.display = "none";
        }

        // Price
        productPrice.innerText = product.mrp ? `﷼ ${product.mrp}` : "";

        // Details left
        details.innerHTML = `
          <div class="row"><span class="label">Name:</span> <span>${formatText(product.name)}</span></div>
          <div class="row"><span class="label">Qty:</span> <span>${product.qty}</span></div>
          <div class="row"><span class="label">Unit:</span> <span>${product.unit}</span></div>
          <div class="row"><span class="label">Magas:</span> <span>${product.magas}</span></div>
          <div class="row"><span class="label">Brand:</span> <span>${formatText(product.brand)}</span></div>
          <div class="row"><span class="label">Usage:</span> <span>${formatText(product.usage)}</span></div>
        `;
        resultBox.style.display = "block";
      } else {
        heading.innerHTML = "Product Details";
        details.innerHTML = `<div class="row">No product found for code: ${code}</div>`;
        productImage.style.display = "none";
        productPrice.innerText = "";
        resultBox.style.display = "block";
      }
    }

    // Flexible search: barcode OR product name with partial multi-word match
    function searchProduct() {
      const query = document.getElementById("searchInput").value.trim().toLowerCase();
      if (!query) return;

      // If exact barcode
      if (inventory[query]) {
        showProduct(query);
        return;
      }

      const terms = query.split(/\s+/);
      const results = Object.values(inventory).filter(product => {
        const words = (product.name || "").toLowerCase().split(/\s+/);
        return terms.every((t, i) =>
          words[i] && words[i].startsWith(t)
        );
      });

      if (results.length > 0) {
        // Show first match
        const barcode = Object.keys(inventory).find(bc => inventory[bc] === results[0]);
        showProduct(barcode);
      } else {
        document.getElementById("details").innerHTML = `<div class="row">No product found for: ${query}</div>`;
        document.getElementById("result").style.display = "block";
      }
    }

    // Scanner open/close
    async function toggleScan() {
      const qrReader = document.getElementById("qr-reader");

      if (!scanning) {
        qrReader.style.display = "block";
        html5QrCode = new Html5Qrcode("qr-reader");

        try {
          const cameras = await Html5Qrcode.getCameras();
          if (cameras && cameras.length) {
            let backCamera = cameras[cameras.length - 1].id;
            await html5QrCode.start(
              { deviceId: { exact: backCamera } },
              { fps: 10, qrbox: { width: 220, height: 220 } },
              (decodedText) => {
                showProduct(decodedText);
                toggleScan(); // auto close
              }
            );
            scanning = true;
          }
        } catch (err) {
          console.error("Camera error:", err);
          alert("Unable to access camera: " + err);
        }
      } else {
        if (html5QrCode) {
          await html5QrCode.stop();
          html5QrCode.clear();
        }
        qrReader.style.display = "none";
        scanning = false;
      }
    }
  </script>
</body>
</html>
